<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ข้อมูลโรงไฟฟ้า</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../style.css">
</head>
<body class="plant-page">
  <div class="shell">
    <div class="top-controls">
      <div class="left-group">
        <button class="ghost back-btn icon-btn" id="back-btn" type="button" aria-label="กลับหน้ารายการ" title="กลับหน้ารายการ">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="mode-toggle">
          <button class="toggle-btn active" id="mode-meters" type="button">Meters</button>
          <button class="toggle-btn" id="mode-billing" type="button">Billing</button>
        </div>
      </div>
    </div>

    <section class="plant-hero">
      <div>
        <p class="eyebrow">Plant</p>
        <h1 id="plant-name">ชื่อโรงไฟฟ้า</h1>
      </div>
    </section>

    <section class="panel" id="meters-panel">
      <div class="panel-head">
        <h3>มิเตอร์ / Meters</h3>
        <div class="panel-actions">
          <button class="primary small-btn" id="meter-new-btn" type="button">เพิ่มมิเตอร์</button>
        </div>
      </div>
      <div class="device-table-wrap">
        <table class="device-table">
          <thead>
            <tr>
              <th style="width: 80px;">Status</th>
              <th>Meter</th>
              <th style="width: 220px;">Address</th>
              <th style="width: 110px;">จัดการ</th>
            </tr>
          </thead>
          <tbody id="device-rows">
            <tr><td class="empty" colspan="4">กำลังโหลด...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="panel hidden" id="billing-panel">
      <div class="panel-head">
        <h3>บิลค่าไฟ / Billing</h3>
        <div class="panel-actions">
          <button class="primary small-btn" id="bill-new-btn" type="button">สร้างบิลใหม่</button>
        </div>
      </div>
      <div class="bill-flow-tabs" id="bill-flow-tabs">
        <button class="bill-flow-btn active" id="bill-flow-manual" type="button">ออกบิลแบบกำหนดวัน</button>
        <button class="bill-flow-btn" id="bill-flow-auto" type="button">ออกบิลอัตโนมัติ</button>
      </div>
      <div class="panel-sub hidden" id="bill-queue-panel">
        <div class="summary-header">
          <h4 id="bill-queue-title">รายการรอบบิลอัตโนมัติที่ตั้งค่าไว้</h4>
        </div>
        <div class="history-wrap">
          <table class="history-table">
            <thead>
              <tr>
                <th style="width: 110px;">รอบวันที่</th>
                <th style="width: 190px;">ตั้งค่าเมื่อ</th>
                <th>รายละเอียด</th>
                <th style="width: 130px;">สถานะ</th>
                <th style="width: 180px;">การทำงาน</th>
              </tr>
            </thead>
            <tbody id="bill-queue-rows">
              <tr><td class="empty" colspan="5">ยังไม่มีรอบอัตโนมัติ</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="panel-sub" id="bill-history-panel">
        <div class="summary-header">
          <h4 id="bill-history-title">ประวัติการสร้างบิลแบบกำหนดวัน</h4>
        </div>
        <div class="history-wrap">
          <table class="history-table">
            <thead>
              <tr>
                <th style="width: 90px;">ใบที่</th>
                <th>สร้างจากมิเตอร์</th>
                <th>ช่วงวันที่</th>
                <th style="width: 130px;">อัตรา (฿/kWh)</th>
                <th style="width: 140px;">หน่วยรวม (kWh)</th>
                <th style="width: 140px;">ยอดรวม</th>
                <th style="width: 140px;">การทำงาน</th>
              </tr>
            </thead>
            <tbody id="bill-history-rows">
              <tr><td class="empty" colspan="7">ยังไม่มีบิล</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="panel-sub hidden" id="receipt-history">
        <div class="summary-header">
          <h4 id="receipt-title">ประวัติรายงานบิล</h4>
          <button class="ghost small-btn" id="receipt-close" type="button">ปิด</button>
        </div>
        <div class="history-wrap">
          <table class="history-table">
            <thead>
              <tr>
                <th style="width: 160px;">เดือน</th>
                <th style="width: 110px;">จำนวนวัน</th>
                <th style="width: 180px;">วันที่ออกรายงาน</th>
                <th style="width: 160px;">ดาวน์โหลด</th>
                <th style="width: 170px;">ตัวอย่าง</th>
              </tr>
            </thead>
            <tbody id="receipt-rows">
              <tr><td class="empty" colspan="5">ยังไม่มีประวัติรายงานบิล</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal hidden" id="auto-round-modal" role="dialog" aria-modal="true">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="auto-round-modal-title">ประวัติการออกบิลอัตโนมัติ</h3>
            <button class="ghost icon-btn" id="auto-round-modal-close" aria-label="ปิด">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="history-wrap">
              <table class="history-table">
                <thead>
                  <tr>
                    <th style="width: 90px;">ใบที่</th>
                    <th style="width: 210px;">ช่วงวันที่</th>
                    <th style="width: 150px;">หน่วยรวม (kWh)</th>
                    <th style="width: 140px;">ยอดรวม</th>
                    <th style="width: 160px;">สร้างเมื่อ</th>
                    <th style="width: 170px;">การทำงาน</th>
                  </tr>
                </thead>
                <tbody id="auto-round-modal-rows">
                  <tr><td class="empty" colspan="6">ยังไม่มีประวัติ</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button class="ghost small-btn" id="auto-round-modal-close-footer" type="button">ปิด</button>
          </div>
        </div>
      </div>
    </section>

    <div class="modal hidden" id="receipt-preview-modal" role="dialog" aria-modal="true">
      <div class="modal-content receipt-preview">
        <div class="modal-header">
          <div>
            <h3>ตัวอย่างรายงานบิล</h3>
            <p class="muted small" id="receipt-preview-month"></p>
          </div>
          <div class="header-actions">
            <button class="primary small-btn" id="receipt-preview-download" type="button">ดาวน์โหลด PDF</button>
            <button class="ghost icon-btn" id="receipt-preview-close" aria-label="ปิด">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
        <div class="modal-body">
          <div id="receipt-preview-viewport" class="receipt-preview-viewport">
            <div id="receipt-preview-content" class="receipt-preview-content"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="bill-modal" role="dialog" aria-modal="true">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="bill-modal-title">สร้างใบแจ้งค่าไฟ</h3>
          <button class="ghost icon-btn" id="bill-modal-close" aria-label="ปิด">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="field hidden" id="bill-auto-preview-field">
            <p class="muted small" id="bill-auto-preview">ระบบจะสร้างบิลตามรอบอัตโนมัติ</p>
          </div>
          <div class="field grid-2" id="bill-date-range-field">
            <div>
              <label for="bill-start">วันที่เริ่ม</label>
              <input type="date" id="bill-start">
            </div>
            <div>
              <label for="bill-end">ถึงวันที่</label>
              <input type="date" id="bill-end">
            </div>
          </div>
          <div class="field grid-2">
            <div>
              <label for="bill-rate">อัตรา (฿/kWh)</label>
              <input type="number" id="bill-rate" step="0.01">
            </div>
            <div>
              <label for="bill-type">ประเภทอัตรา</label>
              <select id="bill-type">
                <option value="flat">Flat rate</option>
                <option value="tou">TOU</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label>รูปแบบคำนวณหน่วย</label>
            <div class="calc-mode-actions">
              <div class="calc-mode-switch" id="calc-mode-switch" role="tablist" aria-label="รูปแบบคำนวณหน่วย">
                <button class="calc-mode-btn active" id="calc-mode-single" type="button">ออกบิลค่าเดี่ยว</button>
                <button class="calc-mode-btn" id="calc-mode-formula" type="button">ออกบิลแบบคำนวณ</button>
              </div>
              <button
                class="ghost icon-btn calc-reset-btn"
                id="calc-mode-reset"
                type="button"
                aria-label="รีเซ็ตรูปแบบคำนวณหน่วย"
                title="รีเซ็ตค่ารูปแบบคำนวณหน่วย"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M20 12a8 8 0 1 1-2.34-5.66" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M20 4v4h-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="field">
            <div class="formula-inline-grid" id="formula-inline-grid">
              <div class="formula-inline-cell" id="formula-meter-left-cell">
                <label for="formula-meter-left" id="formula-meter-left-label">ชื่อมิเตอร์</label>
                <select id="formula-meter-left"></select>
              </div>
              <div class="formula-inline-cell" id="formula-value-left-cell">
                <label for="formula-value-left" id="formula-value-left-label">ค่าที่ใช้คำนวณ</label>
                <select id="formula-value-left"></select>
              </div>
              <div class="formula-inline-cell formula-op-cell" id="formula-op-cell">
                <label for="formula-operator">เครื่องหมาย</label>
                <select id="formula-operator">
                  <option value="+">+</option>
                  <option value="-">-</option>
                  <option value="*">*</option>
                  <option value="/">/</option>
                </select>
              </div>
              <div class="formula-inline-cell" id="formula-meter-right-cell">
                <label for="formula-meter-right">ชื่อมิเตอร์</label>
                <select id="formula-meter-right"></select>
              </div>
              <div class="formula-inline-cell" id="formula-value-right-cell">
                <label for="formula-value-right">ค่าที่ใช้คำนวณ</label>
                <select id="formula-value-right"></select>
              </div>
              <div class="formula-inline-cell" id="formula-result-name-cell">
                <label for="formula-result-name">ชื่อผลคำนวณ</label>
                <input type="text" id="formula-result-name">
              </div>
              <div class="formula-inline-cell" id="formula-result-value-cell">
                <label for="formula-result-value">ผลคำนวน</label>
                <input type="text" id="formula-result-value" readonly value="-">
              </div>
            </div>
            <div class="formula-column-builder hidden" id="formula-column-builder">
              <div class="formula-column-builder-head">
                <button class="chip-btn" id="formula-add-column-btn" type="button">
                  เพิ่มคอลัมน์
                </button>
                <button class="chip-btn" id="formula-add-calc-column-btn" type="button">
                  เพิ่มคอลัมคำนวณ
                </button>
                <button class="chip-btn ghost" id="formula-remove-column-btn" type="button">
                  ลบคอลัมน์
                </button>
              </div>
              <div class="formula-columns-boxes" id="formula-columns-boxes"></div>
            </div>
          </div>
          <div class="field" id="bill-cutoff-field">
            <label for="bill-cutoff">ตัดรอบวันที่</label>
            <select id="bill-cutoff"></select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="ghost small-btn" id="bill-cancel" type="button">ยกเลิก</button>
          <button class="primary" id="bill-confirm" type="button">สร้างบิล</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="meter-create-modal" role="dialog" aria-modal="true">
      <div class="modal-content small">
        <div class="modal-header">
          <h3>เพิ่มมิเตอร์</h3>
          <button class="ghost icon-btn" id="meter-create-modal-close" aria-label="ปิด">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="field">
            <label for="meter-create-type">ประเภทอุปกรณ์</label>
            <select id="meter-create-type">
              <option value="SOLAR_PANEL">โซล่าร์ (SOLAR_PANEL)</option>
              <option value="METER">มิเตอร์ (METER)</option>
              <option value="MDB_IN">มิเตอร์ขาเข้า (MDB_IN)</option>
              <option value="MDB_OUT">มิเตอร์ขาออก (MDB_OUT)</option>
            </select>
          </div>
          <div class="field">
            <label for="meter-create-name">ชื่ออุปกรณ์</label>
            <input
              id="meter-create-name"
              type="text"
              autocomplete="off"
              placeholder="เช่น Main Solar Inverter"
            />
          </div>
          <div class="meter-create-section meter-create-section-import">
            <p class="meter-create-section-title">Modbus Address ขาเข้า (Import)</p>
            <div class="grid-2 meter-create-grid">
              <div class="field">
                <label for="meter-create-in-1">Address IN 1 (High Word)</label>
                <input id="meter-create-in-1" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="เช่น 43205" />
              </div>
              <div class="field">
                <label for="meter-create-in-2">Address IN 2 (Low Word)</label>
                <input id="meter-create-in-2" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="เช่น 43206" />
              </div>
            </div>
          </div>
          <div class="meter-create-section meter-create-section-export">
            <p class="meter-create-section-title">Modbus Address ขาออก (Export)</p>
            <div class="grid-2 meter-create-grid">
              <div class="field">
                <label for="meter-create-out-1">Address OUT 1 (High Word)</label>
                <input id="meter-create-out-1" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="เช่น 43209" />
              </div>
              <div class="field">
                <label for="meter-create-out-2">Address OUT 2 (Low Word)</label>
                <input id="meter-create-out-2" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="เช่น 43210" />
              </div>
            </div>
            <p class="muted small meter-create-note">* ไม่บังคับ หากไม่มีขาออกสามารถเว้นว่างได้</p>
          </div>
        </div>
        <div class="modal-footer">
          <button class="ghost small-btn" id="meter-create-cancel" type="button">ยกเลิก</button>
          <button class="primary" id="meter-create-confirm" type="button">เพิ่มมิเตอร์</button>
        </div>
      </div>
    </div>

  <script src="./plant.js" defer></script>
  <script src="../billing/billing.js" defer></script>
  <script src="../meters/meters.js" defer></script>
</body>
</html>
